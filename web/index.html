<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 12px; }
    #card-container { margin: 10px 0; min-height: 48px; }
    #payBtn { padding: 10px 14px; font-weight: 700; width: 100%; }
    #status { margin-top: 10px; font-weight: 700; white-space: pre-wrap; }
    #debug {
      margin-top: 12px;
      padding: 10px;
      background: #111;
      color: #0f0;
      border-radius: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 12px;
      white-space: pre-wrap;
      max-height: 240px;
      overflow: auto;
      display: none; /* hide until we log */
    }
  </style>
</head>
<body>
  <div id="card-container"></div>
  <button id="payBtn" disabled>Continue</button>
  <div id="status"></div>
  <div id="debug"></div>

<script>
  const params = new URLSearchParams(location.search);
  const env = (params.get("env") || "sandbox").toLowerCase();
  const appId = (params.get("appId") || "").trim();
  const locationId = (params.get("locationId") || "").trim();
  const parentOrigin = (params.get("parentOrigin") || "*").trim();

  const statusEl = document.getElementById("status");
  const debugEl = document.getElementById("debug");
  const btn = document.getElementById("payBtn");

  function now() { return new Date().toISOString().slice(11, 23); }

  function safeStringify(x) {
    try { return JSON.stringify(x, Object.getOwnPropertyNames(x), 2); }
    catch (_) { try { return String(x); } catch (_) { return "[unstringifiable]"; } }
  }

  function post(obj) {
    try { window.parent.postMessage(obj, parentOrigin); }
    catch (e) { /* ignore */ }
  }

  function log(line, obj) {
    debugEl.style.display = "block";
    const msg = `[${now()}] ${line}` + (obj ? `\n${safeStringify(obj)}` : "");
    debugEl.textContent = (msg + "\n\n" + debugEl.textContent).slice(0, 8000);
    post({ type: "squareDebug", message: line, detail: obj || null });
  }

  function setStatus(t) { statusEl.textContent = t || ""; }
  function setEnabled(v) { btn.disabled = !v; }

  window.addEventListener("error", (e) => {
    log("window.onerror", { message: e.message, filename: e.filename, lineno: e.lineno, colno: e.colno });
    post({ type: "squareError", message: `JS error: ${e.message}` });
  });

  window.addEventListener("unhandledrejection", (e) => {
    const r = e.reason;
    log("unhandledrejection", { reason: r, message: r?.message, stack: r?.stack });
    post({ type: "squareError", message: `Promise rejection: ${r?.message || r}` });
  });

  const script = document.createElement("script");
  script.src = env === "production"
    ? "https://web.squarecdn.com/v1/square.js"
    : "https://sandbox.web.squarecdn.com/v1/square.js";

  script.onload = () => log("Square script loaded", { src: script.src });
  script.onerror = () => {
    const msg = "Square JS failed to load.";
    setStatus(msg);
    log(msg, { src: script.src });
    post({ type: "squareError", message: msg });
  };
  document.head.appendChild(script);

  let card;

  async function waitForSquare(maxMs = 8000) {
    const start = Date.now();
    while (!window.Square) {
      if (Date.now() - start > maxMs) return false;
      await new Promise(r => setTimeout(r, 50));
    }
    return true;
  }

  async function init() {
    log("init() starting", { env, appId, locationId, parentOrigin, href: location.href, isSecureContext: window.isSecureContext });

    if (!window.isSecureContext) {
      const msg = "Not a secure context (must be HTTPS).";
      setStatus(msg);
      log(msg);
      post({ type: "squareError", message: msg });
      return;
    }

    if (!appId || !locationId) {
      const msg =
        "Missing appId/locationId in query params.\n\n" +
        "Open via iframe with:\n" +
        "?env=sandbox&appId=...&locationId=...&parentOrigin=https://your-site";
      setStatus(msg);
      log("Missing params", { appId, locationId });
      post({ type: "squareError", message: msg });
      return;
    }

    const okAppId =
      (env === "sandbox" && appId.startsWith("sandbox-sq0idb-")) ||
      (env === "production" && appId.startsWith("sq0idb-"));

    if (!okAppId) {
      const msg = `Invalid applicationId format for env=${env}. appId=${appId}`;
      setStatus(msg);
      log(msg);
      post({ type: "squareError", message: msg });
      return;
    }

    log("Waiting for window.Square...");
    const ok = await waitForSquare();
    if (!ok) {
      const msg = "Square SDK did not become available (window.Square missing).";
      setStatus(msg);
      log(msg);
      post({ type: "squareError", message: msg });
      return;
    }

    try {
      log("Creating payments instance...");
      const payments = window.Square.payments(appId, locationId);

      log("Creating card instance...");
      card = await payments.card();

      log("Attaching card...");
      await card.attach("#card-container");

      setEnabled(true);
      setStatus("");
      log("Card attached successfully.");
      post({ type: "squareReady" });
    } catch (e) {
      const msg = e?.message || String(e);
      setStatus(msg);
      log("init() error", { message: msg, stack: e?.stack, raw: e });
      post({ type: "squareError", message: msg });
    }
  }

  async function tokenize() {
    setEnabled(false);
    setStatus("");
    log("tokenize() clicked");

    try {
      if (!card) {
        const msg = "Card is not initialized (card=null).";
        setStatus(msg);
        log(msg);
        post({ type: "squareError", message: msg });
        setEnabled(true);
        return;
      }

      const r = await card.tokenize();
      log("tokenize() result", r);

      if (r.status === "OK" && r.token) {
        post({ type: "squareToken", token: r.token });
      } else {
        const msg = (r.errors || []).map(x => x.message).join(" | ") || "Tokenize failed";
        setStatus(msg);
        post({ type: "squareError", message: msg });
        setEnabled(true);
      }
    } catch (e) {
      const msg = e?.message || String(e);
      setStatus(msg);
      log("tokenize() error", { message: msg, stack: e?.stack, raw: e });
      post({ type: "squareError", message: msg });
      setEnabled(true);
    }
  }

  document.getElementById("payBtn").addEventListener("click", tokenize);
  init();
</script>
</body>
</html>
